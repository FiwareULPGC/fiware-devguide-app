# Complex Event Processing (CEP) example

This document explains the configuration and use of the CEP with a simple example.  For a detailed explanation of CEP, please read the official documentation available at https://proactive-technology-online.readthedocs.org/en/latest/index.html.

In this example we are going to define a new project, load it on our CEP server, process some events and produce some output to a file.  Our scenario is pretty simple.  We have some temperature sensors that we want to monitor and raise alerts when the temperature raises above or drops below a certain threshold.  For this example we'll be using the sensors generated by the ul20-client container.

## Create a new project definition

The first step is to create a new project with the help of the [AuthoringTool](http://cep-proton:8080/AuthoringTool/).  You can find and load this example from the file [TemperatureExample.json](https://github.com/Fiware/tutorials.TourGuide-App/blob/master/docker/images/tutorials.tourguide-app/TemperatureExample.json).  For this example to work we need to define:

* Producers: to introduce external events to the system
* Events: the diferent events that we want to process.
* EPAs: the Event Processing Agents to process those events.
* Temporal Contexts: time windows for the EPAs
* Segmentation Contexts: to group events for the same entity
* Composite Contexts: to group one or more context
* Consumers: to consume events and send them to the outside world

### Producers ###

In this example we are not going to define a producer, but instead we'll be using the data sent from the Orion Context Broker (CB).  This just requires a subscription to receive notifications from the CB.  To do this, we can create a JSON file with the following content:

```json
{
    "entities": [
        {
            "type": "thing",
            "isPattern": "true",
            "id": "SENSOR_TEMP_.*"
        }
    ],
    "attributes": [
        "temperature"
    ],
    "reference": "${CEP_URL}",
    "duration": "P1M",
    "notifyConditions": [
        {
            "type": "ONCHANGE",
            "condValues": [
                "TimeInstant"
            ]
        }
    ]
}
```

Here we have defined the entities we want to receive notifications from (_SENSOR_TEMP.*_), the attributes (_temperature_) and the endpoint where we want the CB to send the notifications to (_CEP_URL_).  In our example, _CEP_URL_ will be

```
http://<cep-host>:8080/ProtonOnWebServer/rest/events
```

with:

* \<cep-host\> being the hostname or IP address of the CEP container as seen from the CB.

To enable de subscription, we can use curl like this:

```
curl http://localhost:1026/v1/subscribeContext -s -S \
--header 'Content-Type: application/json' \
--header 'Accept: application/xml' \
--header 'Fiware-Service: tourguideul20' \
--header 'Fiware-ServicePath: /' \
-d @subscription.json
```

with:

* our CB listening on port 1026 on localhost,
* subscription.json being a file with the JSON we defined earlier for the subscription,

Please note that the `Accept` header has the value `application/xml`.  As of this writing, this is needed because the CEP implementation does not support (yet) the JSON format used by the CB, only XML.

### Events ###

Here we are going to define three events:

* **thingContextUpdate**:  this will be generated for every notification received from the CB for entities of type `thing`.  In this event we define the attributes we are interested in, _temperature_, _entityType_ and _entityId_.
* **HighTemperatureAlert**:  this will be generated every time the _WarningHighTemperatureRule_ EPA triggers an event (see below).  Here we just want the _temperature_ and _entityId_ attributes.
* **LowTemperatureAlert**:  this will be generated every time the _WarningLowTemperatureRule_ EPA triggers an event (see below).  Here we just want the _temperature_ and _entityId_ attributes.

### EPAs ###

Here we define the rules that will trigger the alerts:

* **WarningHighTemperatureRule**: Raise an issue when temperature rises above a given threshold (50 degrees Celsius) for 30 seconds.
* **WarningLowTemperatureRule**: Raise an issue when temperature drops below a given threshold (30 degrees Celsius) for 30 seconds.

### Contexts ###

Here we define the different context needed for our EPAs:

#### Temporal Contexts ####

* **WarningHighTempWindow**:  this will define the temporal window for the _WarningHighTemperatureRule_, i.e. temperature above 50 degrees Celsius in a 30 seconds interval.
* **WarningLowTempWindow**: this will define the temporal window for the _WarningLowTemperatureRule_, i.e. temperature below 30 degrees Celsius in a 30 seconds interval.

#### Segmentation Contexts ####

* **thingID**: this will define the attribute used to segment the events.  In our example it is the _entityId_ attribute.

#### Composite Contexts ####

* **WarningHighTempComp**:  this will combine the _thingID_ and _WarningHighTempWindow_ contexts for the _WarningHighTemperatureRule_ EPA.
* **WarningLowTempComp**:  this will combine the _thingID_ and _WarningLowTempWindow_ contexts for the _WarningLowTemperatureRule_ EPA.

### Consumers ###

Here we are going to define a new consumer for the events _HighTemperatureAlert_ and _LowTemperatureAlert_.

* **SensorTempConsumer**:  this will create a JSON file where the CEP will write the alerts.

## Upload the project definition to the server

There are two ways we can upload the new project definition to the server:

### Using the Authoring Tool ###

Using the Authoring Tool, available at http://\<cep-host\>:8080/AuthoringTool/, we can import the project definition via the `Import project...` button.  Here we select the JSON file of our example.  Once the project is loaded, we can use the `Save and Export` button to `Export to external repository`.  This will allow us to send the project to the server and store it with in the definitions directory.

### Doing a PUT HTTP request ###

Another option is to do a PUT HTTP request to upload the project definition directly to our server.  To do this we can use curl like this:

```
curl -s -S \
--request PUT \
--header 'Content-Type: application/json' \
http://<cep-host>:8080/ProtonOnWebServerAdmin/resources/definitions/TemperatureExample \
-d @TemperatureExample.json
```

with:

* \<cep-host\> being the hostname or IP address of the CEP container,
* TemperatureExample.json being the JSON file with our project definition.

If the request is successful, it should return a 200 HTTP code.  Please note that if there is alread a definition on the server with the same name, this request will overwrite that definition with the new one.

## Select the new project definition

We can change the project definition loaded by the server via a PUT HTTP request.  To do this we must send the following JSON:

```json
{
  "action": "ChangeDefinitions",
  "definitions-url": "/ProtonOnWebServerAdmin/resources/definitions/TemperatureExample"
}
```

We can send this request using curl like this:

```
curl -s -S \
--request PUT \
--header 'Content-Type: application/json' \
http://<cep-host>:8080/ProtonOnWebServerAdmin/resources/instances/ProtonOnWebServer \
-d @change-definition.json
```

with:

* \<cep-host\> being the hostname or IP address of the CEP container,
* change-definition.json being the JSON file with the change definition request we've defined earlier.

If the request is successful, it should return a 200 HTTP code.

We can check which definition is currently loaded by doing a GET HTTP request to  http://\<cep-host\>:8080/ProtonOnWebServerAdmin/resources/instances/ProtonOnWebServer.  In our example, the response should be:

```json
{
  "state": "started",
  "definitions-url": "/ProtonOnWebServerAdmin/resources/definitions/TemperatureExample"
}
```

This shows which project definition is currently loaded.  Ignore the `state` field for now.

## Restart the server instance

The last step is to restart our server instance to load the new project definition and start using it.  To do this we must send first a stop command with the following JSON:

```json
{
  "action": "ChangeState",
  "state": "stop"
}
```

Then we must send a start command with the following JSON:

```json
{
  "action": "ChangeState",
  "state": "start"
}
```

To send any of this commands, we must send a PUT HTTP request, i.e. with curl, like this:

```
curl -s -S \
--request PUT \
--header 'Content-Type: application/json' \
http://<cep-host>:8080/ProtonOnWebServerAdmin/resources/instances/ProtonOnWebServer \
-d @command.json
```

with:

* \<cep-host\> being the hostname or IP address of the CEP container,
* command.json being the JSON file with the command request defined above (stop/start)

If the request is successful, it should return a 200 HTTP code.

We can check the current state of the server instance by doing a GET HTTP request to  http://\<cep-host\>:8080/ProtonOnWebServerAdmin/resources/instances/ProtonOnWebServer.  In our example, the response should be:

```json
{
  "state": "started",
  "definitions-url": "/ProtonOnWebServerAdmin/resources/definitions/TemperatureExample"
}
```

after issuing the `start` command and

```json
{
  "state": "stopped",
  "definitions-url": "/ProtonOnWebServerAdmin/resources/definitions/TemperatureExample"
}
```

after issuing the `stop` command.

## Check project output ##

Once we have the project definition loaded and running we should see the results on the file `/tmp/SensorTemp.txt` inside the CEP contaier.  We can check it with the following command:

```
docker exec -i -t <cep-container> tail -F /tmp/SensorTemp.txt
```

with:

* <cep-container> being the CEP container name or ID.

We should see messages like this:

* Low temperature alert
```
{"Cost":"0.0","Certainty":"0.0","Name":"LowTemperatureAlert","EventSource":"","OccurrenceTime":"29\/02\/2016-19:10:45","Duration":"0.0","Annotation":"","entityId":"SENSOR_TEMP_ul20client_ACPI_0_Thermal","EventId":"857e6f02-95ab-41e4-9844-8605c24bcf21","DetectionTime":"29\/02\/2016-19:10:45","temperature":"25"}
```

* High temperature alert
```
{"Cost":"0.0","Certainty":"0.0","Name":"HighTemperatureAlert","EventSource":"","OccurrenceTime":"29\/02\/2016-19:13:31","Duration":"0.0","Annotation":"","entityId":"SENSOR_TEMP_ul20client_ACPI_1_Thermal","EventId":"65367f5b-775a-4c01-8cb9-c444fd84d66e","DetectionTime":"29\/02\/2016-19:13:31","temperature":"69"}
```
